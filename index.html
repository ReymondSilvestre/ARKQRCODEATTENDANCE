<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK - QR Code Attendance Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- INSTRUCTION: Replace this object with your own from Firebase Console ---
  const firebaseConfig = {
    apiKey: "AIzaSyBjOBb_CTu83d8Nn5jo9e0ELByCrNstowQ",
    authDomain: "qrcodeattendance-c3ad0.firebaseapp.com",
    projectId: "qrcodeattendance-c3ad0",
    storageBucket: "qrcodeattendance-c3ad0.firebasestorage.app",
    messagingSenderId: "561593729346",
    appId: "1:561593729346:web:b83443038061b1be7c48db"
  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const attendanceCol = collection(db, "attendance_logs");

        // Make functions globally accessible for the scanner logic
        window.saveToFirebase = async (entry) => {
            try {
                await addDoc(attendanceCol, {
                    ...entry,
                    serverTimestamp: new Date() // Use server-side time for sync
                });
                console.log("Synced to Firebase");
            } catch (e) {
                console.error("Firebase Error: ", e);
            }
        };

        // Real-time listener for the table
        const q = query(attendanceCol, orderBy("serverTimestamp", "desc"), limit(20));
        onSnapshot(q, (snapshot) => {
            const remoteLogs = [];
            snapshot.forEach((doc) => remoteLogs.push(doc.data()));
            window.renderTable(window.pairEntries(remoteLogs));
        });
    </script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #4CAF50;
            --background-color: #f8f9fa;
            --card-background: white;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            padding: 20px;
            margin: 0;
            color: #343a40;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .header-flex {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .logo {
            max-width: 80px;
            height: auto;
        }
        .company-name {
            font-size: 36px;
            color: #212529;
            margin: 0;
            font-weight: 600;
        }
        .company-address {
            font-size: 16px;
            color: #6c757d;
            margin-top: 5px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .scanner-container, .report-container {
            background: var(--card-background);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .scanner-container { flex: 1; min-width: 100%; max-width: 100%; }
        #qr-reader { 
            width: 100%; 
            margin-bottom: 20px; 
            border: 2px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        button { 
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        button:hover { background-color: #0056b3; }

        table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background-color: #e9ecef; font-weight: 600; }
        
        #scan-display {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: var(--card-background); 
            border: 3px solid var(--secondary-color); 
            border-radius: 15px;
            padding: 30px 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999; 
            display: none; 
            text-align: center; 
            font-size: 20px;
            min-width: 300px;
        }
        #scan-display .icon { font-size: 48px; margin-bottom: 10px; }
        #scan-display strong { font-size: 28px; display: block; margin: 5px 0 10px; }

        @media (max-width: 850px) {
            .container { max-width: 95%; }
            .company-name { font-size: 28px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-flex">
        <img src="image/arklogo.png" alt="Company Logo" class="logo"> 
        <div>
            <h1 class="company-name">ARK Technological Institute Education System Inc.</h1>
            <h3 class="company-address">J-Seven Bldg. Magallanes Cor. Granja St. Brgy. 7 Lucena City.</h3>
        </div>
    </div>
</div>

<div class="container">
    <section class="scanner-container">
        <h2>üì∑ QR Code Scanner</h2>
        <div id="qr-reader"></div>
        <p id="camera-status" style="text-align:center; color:gray;"></p>
    </section>
    
    <section class="report-container">
        <h2>üìã Recent Attendance Log (Live Sync)</h2>
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Section</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="report-body"></tbody>
        </table>
        <button onclick="downloadExcel()">‚¨áÔ∏è Download Full Excel Log</button>
    </section>
</div>

<div id="scan-display"></div>

<script>
    const html5QrCode = new Html5Qrcode("qr-reader");
    let scanning = false;
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyEaAfHchWSYuJG4GgDfPR9KdRsaoNQLociaOmqQQEcCXrVF33FjshldVXByjNGRc-h/exec";
    
    let philippineVoice = null;

    function setPhilippineVoice() {
        const voices = speechSynthesis.getVoices();
        philippineVoice = voices.find(v => v.lang.includes('ph') || v.lang.includes('PH')) || 
                         voices.find(v => v.name.includes('Google US English'));
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = setPhilippineVoice;
    }
    setPhilippineVoice();

    function cleanNameForSpeech(name) {
        return name.replace(/\./g, '').trim();
    }

    function formatTimeOnly(str) {
        const date = new Date(str);
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
    }

    function formatDateOnly(dateObj) {
        return dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + String(dateObj.getDate()).padStart(2, '0');
    }

    function getCurrentTime() { return new Date().toString(); }
    function getTodayDate() { return formatDateOnly(new Date()); }

    function getActionType(id) {
        const logs = JSON.parse(localStorage.getItem("attendance") || "[]");
        const today = getTodayDate();
        const todayLogs = logs.filter(e => e.studentID === id && e.date === today);
        if (todayLogs.length === 0) return "Time In";
        return todayLogs[todayLogs.length - 1].action === "Time Out" ? "Time In" : "Time Out";
    }

    function displayScanInfo(id, name, action) {
        const el = document.getElementById("scan-display");
        const icon = action === "Time In" ? "‚û°Ô∏è" : (action === "Time Out" ? "‚¨ÖÔ∏è" : "‚ùå");
        const actionColor = action === 'Failed' ? '#dc3545' : 'var(--secondary-color)';
        const actionText = action === 'Failed' ? 'Scan Failed' : `${action} Recorded`;

        el.innerHTML = `<div class="icon" style="color:${actionColor};">${icon}</div>
                        <div><strong>${actionText}</strong></div>
                        <div>${name}</div>
                        <div style="color:#666; font-size:16px;">ID: ${id}</div>`;
        el.style.display = "block";
        
        speechSynthesis.cancel();
        const speechName = (action === 'Failed' || name === 'Invalid QR Code') ? 'Attention' : cleanNameForSpeech(name);
        const speechAction = action === 'Failed' ? 'Scan failed' : `${action} confirmed`;
        const msg = new SpeechSynthesisUtterance(`${speechName}. ${speechAction}.`);
        
        if (philippineVoice) msg.voice = philippineVoice;
        msg.pitch = 1;
        msg.rate = 0.85; 
        speechSynthesis.speak(msg);
        
        setTimeout(() => el.style.display = "none", 3000);
    }

    function logAttendance(details) {
        const [id, name, section, contact, pictureUrl] = details;
        if (!id || !name || !section) {
            displayScanInfo('N/A', 'Invalid QR Code', 'Failed');
            return;
        }

        const action = getActionType(id);
        const timestamp = getCurrentTime();
        const date = getTodayDate();

        const entry = {
            studentID: id,
            studentName: name,
            studSection: section,
            studContact: contact || 'N/A', 
            studPictureUrl: pictureUrl || 'N/A',
            time: timestamp,
            date: date,
            action: action
        };

        // 1. Save locally
        let logs = JSON.parse(localStorage.getItem("attendance") || "[]");
        logs.push(entry);
        localStorage.setItem("attendance", JSON.stringify(logs));

        // 2. Sync to Firebase (New)
        if (window.saveToFirebase) window.saveToFirebase(entry);

        // 3. Keep Google Sheet as backup
        fetch(GOOGLE_SHEET_URL, {
            method: "POST",
            mode: 'no-cors',
            body: JSON.stringify(entry),
            headers: { "Content-Type": "application/json" }
        });

        displayScanInfo(id, name, action); 
    }

    function onScanSuccess(text) {
        if (scanning) return;
        scanning = true;
        
        const details = text.split('|').map(s => s.trim()); 
        if (details.length >= 3) { 
            logAttendance(details);
        } else {
            displayScanInfo('N/A', 'Invalid QR Code', 'Failed'); 
        }
        setTimeout(() => { scanning = false; }, 5000);
    }

    function startScanner() {
        let qrboxFunction = function(viewfinderWidth, viewfinderHeight) {
            let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
            let qrboxSize = Math.floor(minEdgeSize * 0.7);
            return { width: qrboxSize, height: qrboxSize };
        }

        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 20, qrbox: qrboxFunction, aspectRatio: 1.0 }, 
            onScanSuccess
        )
        .then(() => {
            document.getElementById("camera-status").style.color = 'var(--secondary-color)';
            document.getElementById("camera-status").innerText = 'Camera running... Ready to scan.';
        })
        .catch((err) => {
            document.getElementById("qr-reader").innerHTML = `<button onclick="window.location.reload()">Retry Camera</button>`;
        });
    }

    // Exported for Firebase listener
    window.pairEntries = function(entries) {
        const pairs = [], grouped = {};
        entries.forEach(e => {
            const key = `${e.studentID}_${e.date}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(e);
        });

        Object.values(grouped).forEach(g => {
            g.sort((a,b) => new Date(a.time) - new Date(b.time));
            let i = 0;
            while (i < g.length) {
                const curr = g[i];
                const base = { studentID: curr.studentID, studentName: curr.studentName, studSection: curr.studSection, date: curr.date };
                if (curr.action === "Time In") {
                    let out = null;
                    for (let j = i + 1; j < g.length; j++) {
                        if (g[j].action === "Time Out") { out = g[j]; i = j; break; }
                    }
                    pairs.push({ ...base, timeIn: formatTimeOnly(curr.time), timeOut: out ? formatTimeOnly(out.time) : "-" });
                } else {
                    pairs.push({ ...base, timeIn: "-", timeOut: formatTimeOnly(curr.time) });
                }
                i++;
            }
        });
        return pairs;
    };

    window.renderTable = function(paired) {
        const tbody = document.getElementById("report-body");
        tbody.innerHTML = "";
        const sorted = paired.sort((a, b) => new Date(b.date + ' ' + (b.timeOut !== '-' ? b.timeOut : b.timeIn)) - new Date(a.date + ' ' + (a.timeOut !== '-' ? a.timeOut : a.timeIn)));
        const recent = sorted.slice(0, 5); // Show more since multiple users are scanning
        if (recent.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No recent records.</td></tr>`;
            return;
        }
        recent.forEach(e => {
            tbody.innerHTML += `<tr><td>${e.studentID}</td><td>${e.studentName}</td><td>${e.studSection}</td><td style="color:#007bff;">${e.timeIn}</td><td style="color:#dc3545;">${e.timeOut}</td><td>${e.date}</td></tr>`;
        });
    };

    function downloadExcel() {
        let logs = JSON.parse(localStorage.getItem("attendance") || "[]");
        if (logs.length === 0) return alert("No data.");
        const pairedLogs = window.pairEntries(logs);
        const wb = XLSX.utils.book_new();
        const byDate = {};
        pairedLogs.forEach(log => {
            if (!byDate[log.date]) byDate[log.date] = [];
            byDate[log.date].push({ "Date": log.date, "ID": log.studentID, "Name": log.studentName, "Section": log.studSection, "In": log.timeIn, "Out": log.timeOut });
        });
        Object.keys(byDate).sort().reverse().forEach(date => { 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDate[date]), date.slice(5)); 
        });
        XLSX.writeFile(wb, `ARK_Attendance_${getTodayDate()}.xlsx`);
    }

    document.addEventListener("DOMContentLoaded", () => {
        startScanner();
    });
</script>
</body>
</html>
